// Generated by CoffeeScript 1.10.0
(function() {
  var POST, key, render, simplifiedTitle;

  document.on("DOMContentLoaded", function() {
    document.body.innerHTML = "<header>\n  <h1>Lefty Guitars For Sale Under $1000</h1>\n</header>\n<div id=\"articles\"></div>\n\n<div id=\"hosted\">\n  <h6>This site is hosted by</h6>\n  <div id=\"paintedturtle\">\n    <a href=\"\">Painted Turtle instruments</a><br>\n    Well-worm lefty guitars in Ottawa, Ontario<br>\n    <a href=\"mailto:instruments@paintedturtle.xyz\">instruments@paintedturtle.xyz</a>\n  </div>\n</div>\n<div id=\"links\">\n  <h6>Lefty Links</h6>\n  <div id=\"jerrysleftyguitars\">\n    <a href=\"\">Jerry’s Lefty Guitars</a><br>\n    World’s finest collection of lefty guitars in Sarasota, Florida<br>\n    <a href=\"mailto:instruments@paintedturtle.xyz\">instruments@paintedturtle.xyz</a>\n  </div>\n  <div id=\"leftyguitarsonly\">\n    <a href=\"\">Lefty Guitars Only</a><br>\n    Expensive lefty guitars in East Greenwich, Rhode Island<br>\n    <a href=\"mailto:instruments@paintedturtle.xyz\">instruments@paintedturtle.xyz</a>\n  </div>\n</div>\n<style>\n  html { background: #333; color: white;}\n  body { font: 4mm/4mm Consolas; }\n  body, article, div, header, footer, h1, h2, h3, h4, h5, h6 { padding: 0; margin: auto; position: relative; font: inherit; }\n  body > header { position: absolute; top: -100%; }\n  form { width: 300mm; margin: 10mm auto;}\n  form input { width: 100%; margin: auto; font: 4mm/4mm Consolas; }\n  #articles { margin: auto; width: auto; position: relative; overflow:hidden;}\n  article { margin: 0; color: white; font: 4mm/4mm Consolas; width: 33.333%; float: left; outline: 1px solid black; overflow:hidden;}\n  article img { width: 100%; height: 100mm; object-fit: cover; background-color: black; display:block;}\n  article .title { white-space: nowrap; position: absolute; background: black; margin: 1mm; padding: 1mm; bottom: 10mm;}\n  article .price { white-space: nowrap; position: absolute; background: black; margin: 1mm; padding: 1mm; bottom: 5mm;}\n  article .address { white-space: nowrap; position: absolute; background: black; margin: 1mm; padding: 1mm; bottom: 0mm;}\n  article:not(:hover) a { background: transparent; color: inherit;}\n  article:hover a { background: hsl(333, 50%, 50%); color: black; text-decoration: underline;}\n\n  #add { position: fixed; top: 0; left: 0; right: 0;}\n</style>";
    if (location.hostname === "localhost") {
      return document.body.innerHTML += "<form id=\"add\">\n<input type=\"URL\" placeholder=\"Paste a URL to add another guitar\" value=\"\">\n</form>";
    }
  });

  document.on("DOMContentLoaded", function() {
    return d3.json("database.json", function(error, database) {
      if (error) {
        console.error(error);
      }
      window.instruments = Facts();
      window.instruments.datoms = Immutable.Stack(Immutable.fromJS(database));
      console.info(window.instruments.query());
      return render(window.instruments.query());
    });
  });

  document.on("input", "input", function(event, input) {
    console.info(input);
    console.info({
      "input": input.value
    });
    if (input.validity.valid) {
      return POST(input.value);
    }
  });

  key = function(d) {
    return d["title"];
  };

  render = function(data) {
    var article;
    data = data.sort(function(a, b) {
      return b["access time"] - a["access time"];
    });
    article = d3.select("#articles").selectAll("article").data(data, (function(d) {
      return d.title;
    }));
    article.enter().append("article");
    article.html(function(d) {
      return "<div class=\"title\">" + (simplifiedTitle(d.title) || 'Untitled') + "</div>\n<div class=\"price\">" + d.price + "</div>\n<div class=\"address\"><a href=\"" + d.address + "\">" + (d.address.replace("http://www.", "")) + "</a></div>\n<img src=\"" + d.photographs[0] + "\">";
    });
    return article.exit().remove();
  };

  simplifiedTitle = function(title) {
    return title.replace(/guitar\s?/i, "").replace(/lefty\s?/i, "").replace(/left[- ]handed\s?/i, "").replace(/left[- ]hand\s?/i, "").replace("()", "");
  };

  POST = function(location) {
    return d3.xhr(window.location).header("Content-Type", "application/json").post(JSON.stringify({
      location: location
    }), function(error, serialized) {
      var data;
      return console.info(data = JSON.parse(serialized));
    });
  };

}).call(this);
