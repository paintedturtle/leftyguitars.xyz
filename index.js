// Generated by CoffeeScript 1.10.0
(function() {
  var POST, render, renderArticlesWithoutPrices, renderExpiredArticles, renderPocket, simplifiedAddress, simplifiedTitle, toCurrentExpiredNoprice;

  document.on("DOMContentLoaded", function() {
    document.body.innerHTML = "<header>\n  <h1>Lefty Guitars For Sale Under $1000</h1>\n</header>\n\n<h2 hidden>Current</h2>\n<div id=\"current\"></div>\n\n<h2>Recently Departed</h2>\n<div id=\"expired\" class=\"diminished articles\"></div>\n\n<h2>Undefined Price</h2>\n<div id=\"noprice\" class=\"diminished articles\"></div>\n\n<div class=\"turtle\">üê¢</div>\n\n<footer>\n  <div id=\"host\">\n    <h6>This site is hosted by</h6>\n    <div id=\"paintedturtle\">\n      <strong><a target=\"paintedturtle\" href=\"https://paintedturtle.xyz/instruments\">Painted Turtle instruments</a></strong><br>\n      Well-worm lefty guitars &amp; basses<br>\n      Ottawa, Ontario, Canada<br>\n      <a href=\"mailto:instruments@paintedturtle.xyz\">instruments@paintedturtle.xyz</a>\n      <a href=\"https://paintedturtle.xyz/instruments\" class=\"window\"><img src=\"paintedturtleinstruments.png\" alt=\"Visit the Painted Turtle Instruments Website\"></a>\n    </div>\n  </div>\n  <div id=\"links\">\n    <h6>Lefty Links</h6>\n    <div id=\"jerrysleftyguitars\">\n      <strong><a target=\"jerrysleftyguitars\" href=\"https://www.jerrysleftyguitars.com/\">Jerry‚Äôs Lefty Guitars</a></strong><br>\n      World‚Äôs finest collection of lefty guitars<br>\n      Sarasota, Florida, USA<br>\n      <a href=\"mailto:jerry@jerrysleftyguitars.com\">jerry@jerrysleftyguitars.com</a>\n    </div>\n    <div id=\"adkguitar\">\n      <a target=\"leftyguitarsonly\" href=\"https://www.adkguitar.com/\">Adirondack Guitar</a><br>\n      Large selection of new lefty guitars<br>\n      Hudson Falls, New York, USA<br>\n      <a href=\"mailto:support@adkguitar.com\">support@adkguitar.com</a>\n    </div>\n    <div id=\"leftyguitarsonly\">\n      <a target=\"leftyguitarsonly\" href=\"http://leftyguitarsonly.com/\">Lefty Guitars Only</a><br>\n      Very spendy lefty acoustic &amp; electic guitars<br>\n      East Greenwich, Rhode Island, USA<br>\n      <a href=\"mailto:sales@leftyguitarsonly.com\">sales@leftyguitarsonly.com</a>\n    </div>\n    <div id=\"leftyguitars.be\">\n      <a target=\"leftyguitars.be\" href=\"http://leftyguitars.be/\">Lefty Guitars</a><br>\n      Europe‚Äôs ultimate choice in lefty guitars and basses<br>\n      Peulis, Belgium<br>\n      <a href=\"mailto:patrick@leftyguitars.be\">patrick@leftyguitars.be</a>\n    </div>\n  </div>\n</footer>\n\n<style>\n  body, article, div, header, footer, h1, h2, h3, h4, h5, h6 { padding: 0; margin: auto; position: relative; font: inherit; }\n  a { color: inherit; text-decoration: inherit; }\n  strong { font-weight: inherit; }\n  html { background: #111; color: hsla(0, 0%, 100%, 0.5);}\n  body { font: 4mm/4mm \"Avenir\", sans-serif; font-weight: 600; }\n  body > header { position: absolute; top: -100%; }\n  form { width: 300mm; margin: 10mm auto;}\n  form input { width: 100%; margin: auto; font: 4mm/4mm Consolas; }\n  #current { margin: auto; width: auto; position: relative; overflow:hidden; color: white;}\n  #current article { margin: 0; color: white; width: 33.333%; float: left; overflow:hidden;}\n  #current article img { width: 100%; height: 100mm; object-fit: cover; background-color: black; display:block;}\n  #current article .address { white-space: nowrap; position: absolute; background: hsla(0, 0%, 0%, 0.66); margin: 0 2mm; padding: 1mm; bottom: 19mm;}\n  #current article .title { white-space: nowrap; position: absolute; background: hsla(0, 0%, 0%, 0.66); margin: 0 2mm; padding: 1mm; bottom: 13mm;}\n\n  #current article .id { white-space: nowrap; position: absolute; margin: 1mm; padding: 1mm; top: 0; left:0; font-size: 50%; }\n  #current article .publication { white-space: nowrap; position: absolute; margin: 1mm; padding: 1mm; top: 0mm; background:black; display:none;}\n\n  #current article .price { position: absolute; margin: 0 2mm; height:5mm; left: 0; bottom: 8mm; background: hsla(0, 0%, 0%, 0.66); right:0; overflow:hidden; }\n  #current article .price .label { white-space: nowrap; position: absolute; margin: 0; width: 15mm; height:4mm; padding: 1mm 1mm 2mm; top: 0; left:0; background:transparent; text-align: right;}\n  #current article .price .graphic { position: absolute; margin: 1mm 1px 0.33mm; height:3.66mm; bottom: 0; left:17mm; background:hsla(0, 0%, 99%, 1);}\n\n  #current article .duration { position: absolute; margin: 0 2mm 0; height:6mm; left: 0; bottom: 2mm; right:0; background: hsla(0, 0%, 0%, 0.66); overflow:hidden; }\n  #current article .duration .label { white-space: nowrap; position: absolute; margin: 0; width: 15mm; height:4mm; padding: 1mm 1mm 2mm; top: 0; left:0; background:transparent; text-align: right; color: hsla(0, 0%, 66%, 1);}\n  #current article .duration .graphic { position: absolute; margin: 1mm 1px 1.33mm; height:3.66mm; bottom: 0mm; left:17mm; background:hsla(0, 0%, 66%, 1);}\n\n\n  article:not(:hover) a { background: transparent; color: inherit;}\n  article a[href]:not(:visited) { color: hsl(205, 50%, 50%); }\n  article a[href]:visited { color: hsl(278, 50%, 50%); }\n\n  h2 { margin: 10mm auto 0; }\n  div.diminished.articles { margin: 0 auto 10mm; width: auto; position: relative; overflow:hidden; color: white;}\n  div.diminished.articles article { margin: 0; color: white; width: 10%; float: left; overflow:hidden;}\n  div.diminished.articles article img { width: 100%; height: 50mm; object-fit: cover; background-color: black; display:block;}\n\n\n  body > footer { line-height: 5mm; }\n\n  #host { position: absolute; top: 0; left: 0; width: 33.333%; text-align: right; }\n  #host > h6 { padding: 10mm 2mm 2mm; }\n  #links { margin: 0 0 0 66.666%;  }\n  #links > h6 { padding: 10mm 2mm 2mm; }\n  #links > div { margin: 4mm 0; padding: 2mm; }\n\n  a.window { display:block; box-shadow: 0 0 1mm 0 black; border-top: 1mm solid hsla(0, 0%, 100%, 0.44);}\n  a.window img { width: 100%; display:block;}\n\n  #paintedturtle { padding: 2mm; margin: 4mm 0;}\n  #paintedturtle strong a[href] { color:hsl(333,88%,72%); }\n  #paintedturtle a.window { position: absolute; left: 100%; right:-100%; top: -21mm; transform: scale(0.88)rotate(-1.11deg); transition: all 222ms ease-out;}\n  #paintedturtle a.window:hover { transform: scale(0.99)rotate(+0.11deg); }\n\n  body .turtle { text-align: center; padding: 3% 1% 1%; color: white; font-size: 200%;}\n</style>";
    if (location.hostname === "localhost") {
      return document.body.innerHTML += "<form id=\"add\">\n  <input type=\"URL\" placeholder=\"Paste a URL to add another guitar\" value=\"\">\n</form>\n<form id=\"pocket\">\n  <input type=\"text\" placeholder=\"Paste an ID to pocket an article\" value=\"\" maxlength=\"64\" minlength=\"64\">\n</form>\n<div id=\"pocketd\" class=\"diminished articles\"></div>";
    }
  });

  document.on("DOMContentLoaded", function() {
    return d3.json("database.json", function(error, database) {
      var current, expired, noprice, pocketd, ref;
      if (error) {
        console.error(error);
      }
      window.instruments = Facts();
      window.instruments.datoms = Immutable.Stack(Immutable.fromJS(database));
      ref = window.instruments.query().reduce(toCurrentExpiredNoprice), current = ref.current, expired = ref.expired, noprice = ref.noprice, pocketd = ref.pocketd;
      render(current);
      renderExpiredArticles(expired);
      renderArticlesWithoutPrices(noprice);
      if (location.hostname === "localhost") {
        return renderPocket(pocketd);
      }
    });
  });

  toCurrentExpiredNoprice = function(reduction, guitar) {
    if (reduction == null) {
      reduction = {};
    }
    if (reduction.current == null) {
      reduction.current = [];
    }
    if (reduction.expired == null) {
      reduction.expired = [];
    }
    if (reduction.noprice == null) {
      reduction.noprice = [];
    }
    if (reduction.pocketd == null) {
      reduction.pocketd = [];
    }
    if (guitar.pocketd) {
      reduction.pocketd.push(guitar);
      return reduction;
    }
    if (guitar.expired) {
      reduction.expired.push(guitar);
      return reduction;
    }
    if (Number.isNaN(Number(guitar["price"].replace("$", "").replace(",", ".").split(".")[0]))) {
      reduction.noprice.push(guitar);
      return reduction;
    }
    reduction.current.push(guitar);
    return reduction;
  };

  document.on("input", "#add input", function(event, input) {
    console.info({
      advance: input.value
    });
    if (input.validity.valid) {
      return d3.xhr("" + window.location).header("Content-Type", "application/json").post(JSON.stringify({
        location: input.value
      }), function(error, response) {
        if (error) {
          console.error(error);
        }
        console.info(response.statusText);
        console.info(JSON.parse(response.responseText));
        return input.value = "";
      });
    }
  });

  document.on("input", "#pocket input", function(event, input) {
    console.info({
      pocket: input.value
    });
    console.info({
      pocket: input.value.length
    });
    if (input.validity.valid) {
      return d3.xhr("" + window.location + input.value).header("Content-Type", "application/json").post(JSON.stringify({
        pocketd: true
      }), function(error, response) {
        if (error) {
          console.error(error);
        }
        console.info(response.statusText);
        console.info(JSON.parse(response.responseText));
        return input.value = "";
      });
    }
  });

  render = function(data) {
    var article;
    data = data.sort(function(a, b) {
      return b["access time"] - a["access time"];
    });
    article = d3.select("#current").selectAll("article").data(data, (function(d) {
      return d.id;
    }));
    article.enter().append("article").attr({
      id: function(d) {
        return d.id;
      }
    });
    article.html(function(d) {
      return "<div class=\"title\">" + (simplifiedTitle(d.title) || 'Untitled') + "</div>\n<div class=\"address\"><a target=\"" + d.id + "\" href=\"" + d.address + "\">" + (simplifiedAddress(d.address)) + "</a></div>\n<div class=\"price\">\n  <div class=\"graphic\" style=\"width:" + (Number(d["price"].replace("$", "").replace(",", ".").split(".")[0]) / 13) + "%\"></div>\n  <div class=\"label\">$ " + (Number(d["price"].replace("$", "").replace(",", ".").split(".")[0])) + "</div>\n</div>\n<div class=\"duration\">\n  <div class=\"graphic\" style=\"width:" + (Math.round((Date.now() - Date.parse(d["publication date"])) / 24..hours() * 1.25)) + "%\"></div>\n  <div class=\"label\">" + (Math.round((Date.now() - Date.parse(d["publication date"])) / 24..hours())) + " days</div>\n</div>\n<img src=\"" + d.photographs[0] + "\">\n<div class=\"id\">" + (location.hostname === "localhost" ? d.id : void 0) + "</div>";
    });
    return article.exit().remove();
  };

  renderPocket = function(data) {
    var article;
    article = d3.select("#pocketd").selectAll("article").data(data, (function(d) {
      return d.id;
    }));
    article.enter().append("article").attr({
      id: function(d) {
        return d.id;
      }
    });
    article.html(function(d) {
      return "<img src=\"" + d.photographs[0] + "\">";
    });
    return article.exit().remove();
  };

  renderExpiredArticles = function(data) {
    var article;
    article = d3.select("#expired").selectAll("article").data(data, (function(d) {
      return d.id;
    }));
    article.enter().append("article").attr({
      id: function(d) {
        return d.id;
      }
    });
    article.html(function(d) {
      return "<img src=\"" + d.photographs[0] + "\">";
    });
    return article.exit().remove();
  };

  renderArticlesWithoutPrices = function(data) {
    var article;
    console.info({
      noprice: data
    });
    article = d3.select("#noprice").selectAll("article").data(data, (function(d) {
      return d.id;
    }));
    article.enter().append("article").attr({
      id: function(d) {
        return d.id;
      }
    });
    article.html(function(d) {
      return "<img src=\"" + d.photographs[0] + "\">";
    });
    return article.exit().remove();
  };

  simplifiedTitle = function(title) {
    return title.replace(/guitar\s?/i, "").replace(/lefty\s?/i, "").replace(/left[- ]handed\s?/i, "").replace(/left[- ]hand\s?/i, "").replace("()", "");
  };

  simplifiedAddress = function(input) {
    return input.replace("http://www.kijiji.ca", "kijiji").replace("/v-view-details.html?adId=", "#");
  };

  POST = function(location) {
    return d3.xhr(window.location).header("Content-Type", "application/json").post(JSON.stringify({
      location: location
    }), function(error, serialized) {
      var data;
      return console.info(data = JSON.parse(serialized));
    });
  };

}).call(this);
